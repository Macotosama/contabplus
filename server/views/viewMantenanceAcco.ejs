<% include partials/header %>
	<!-- BEGIN PAGE -->
	<div class="page-content">
			<!-- BEGIN PAGE CONTAINER-->
			<div class="container-fluid">
				<!-- BEGIN PAGE HEADER-->
				<div class="row-fluid">
					<div class="span12">
						<h3>Mantenimiento de cuentas contables</h3>
					</div>
				</div>

				<div class="row-fluid">
						<div class="span12">
							<!-- BEGIN EXAMPLE TABLE PORTLET-->
							<div class="portlet box light-grey">
								<div class="portlet-title">
									
								</div>
								<div class="portlet-body">									
                                    <form id="accountingAccount" name="accountingAccount" action="#">
                                        <div class="row-fluid">
                                            <div class="control-group span6 ">
                                                <div class="row-fluid">
                                                    <div class="control-group span12 ">
                                                        <label for="accCode">
                                                            Empresa
                                                        </label>
                                                        <div class="controls">
                                                            <% if(business.length == 0) { %>   
                                                                No hay empresas disponibles
                                                            <%} else {%>
                                                            <select id="busId" name="busId" class="span5">   
                                                                <% for(var j = 0; j < business.length; j++) { %>   
                                                                    <option value="<%=business[j].busId%>"> <%=business[j].busName%></option>
                                                                <% }%>
                                                            </select>
                                                            <% }%>
                                                        </div>
                                                    </div>                                            
                                                </div>
                                                <!-- <div class="row-fluid">
                                                    <div class="control-group span6 ">
                                                        <input type="hidden" value="" name="accId" id="accId">
                                                        <label for="accCode">
                                                            Catálogo contable
                                                        </label>
                                                        <div class="controls" id="accIdName">                                                    
                                                        </div>
                                                    </div>	
                                                    <div class="control-group span6 ">
                                                        <label for="accCode">
                                                            Tipo de catálogo
                                                        </label>
                                                        <div class="controls" id="accIsGlobal">                                                    
                                                        </div>
                                                    </div>						
                                                </div> -->
                                                <div class="row-fluid">
                                                    <div class="control-group span6 ">                                                       
                                                        <label for="accCode">
                                                            Catálogo contable
                                                        </label>
                                                        <div class="controls">                                                                    
                                                            <select id="accId" name="accId" class="span10">   
                                                            </select>                                            
                                                        </div>
                                                    </div>	
                                                    <div class="control-group span6 ">                                                        
                                                    </div>						
                                                </div>
                                                <div class="row-fluid">
                                                    <div class="control-group span6 ">
                                                        <label for="accCode">
                                                            Tipo de ingreso
                                                        </label>
                                                        <div class="controls" >
                                                            <select id="aacDirection" name="aacDirection" class="span10">    
                                                                <option value="1">Horizontal</option>                                                    
                                                                <option value="2">Vertical</option>                                                        
                                                            </select>                                                       
                                                        </div>                                              
                                                    </div>							
                                                </div>
                                                <div class="row-fluid" id="horizontal1">
                                                    <div class="control-group span8 ">
                                                        <label for="accCode">
                                                            Codigo de cuenta
                                                        </label>
                                                        <div class="controls"> 
                                                            <input type="text" name="aacCode" id="aacCode" class="span12" />                                                
                                                        </div>
                                                    </div>	
                                                </div>
                                                <div class="row-fluid" id="horizontal2">
                                                    <div class="control-group span8 ">
                                                        <label for="accCode">
                                                            Nombre de la cuenta
                                                        </label>
                                                        <div class="controls" >  
                                                            <input type="text" name="aacName" id="aacName" class="span12" />                                                  
                                                        </div>
                                                    </div>
                                                    <div class="control-group span4 ">
                                                    </div>							
                                                </div>
                                                <div class="row-fluid" id="vertical1">
                                                    <div class="control-group span4 ">
                                                    
                                                    </div>
                                                    <div class="control-group span4 ">
                                                        <label  >
                                                            Nombre de la cuenta
                                                        </label>
                                                    </div>							
                                                </div>
                                                <div class="row-fluid" id="vertical2">
                                                    <div class="control-group span2 ">
                                                        <label class="span12 labelTextNivel" style="padding-left: 13px;" id="labelTextNivel1">
                                                            Nivel 1
                                                        </label>
                                                        <label class="span12 labelTextNivel" id="labelTextNivel2">
                                                            Nivel 2
                                                        </label>
                                                        <label class="span12 labelTextNivel" id="labelTextNivel3">
                                                            Nivel 3
                                                        </label>
                                                        <label class="span12 labelTextNivel" id="labelTextNivel4">
                                                            Nivel 4
                                                        </label>
                                                        <label class="span12 labelTextNivel" id="labelTextNivel5">
                                                            Nivel 5
                                                        </label>
                                                        <label class="span12 labelTextNivel" id="labelTextNivel6">
                                                            Nivel 6
                                                        </label>
                                                        <label class="span12 labelTextNivel" id="labelTextNivel7">
                                                            Nivel 7
                                                        </label>
                                                        <label class="span12 labelTextNivel" id="labelTextNivel8">
                                                            Nivel 8
                                                        </label>
                                                        <label class="span12 labelTextNivel" id="labelTextNivel9">
                                                            Nivel 9
                                                        </label>	
                                                        <label class="span12 labelTextNivel" id="labelTextNivel10">
                                                            Nivel 10
                                                        </label>
                                                        <label class="span12 labelTextNivel" id="labelTextNivel11">
                                                            Nivel 11
                                                        </label>
                                                        <label class="span12 labelTextNivel" id="labelTextNivel12">
                                                            Nivel 12
                                                        </label>
                                                    </div>
                                                    <div class="control-group span2 ">
                                                        <input type="text" name="accNivel1" id="accNivel1" class="m-wrap span12" placeholder="Dígitos">										
                                                        <input type="text" name="accNivel2" id="accNivel2" class="m-wrap span12" placeholder="Dígitos">
                                                        <input type="text" name="accNivel3" id="accNivel3" class="m-wrap span12" placeholder="Dígitos">										
                                                        <input type="text" name="accNivel4" id="accNivel4" class="m-wrap span12" placeholder="Dígitos">
                                                        <input type="text" name="accNivel5" id="accNivel5" class="m-wrap span12" placeholder="Dígitos">										
                                                        <input type="text" name="accNivel6" id="accNivel6" class="m-wrap span12" placeholder="Dígitos">
                                                        <input type="text" name="accNivel7" id="accNivel7" class="m-wrap span12" placeholder="Dígitos">										
                                                        <input type="text" name="accNivel8" id="accNivel8" class="m-wrap span12" placeholder="Dígitos">
                                                        <input type="text" name="accNivel9" id="accNivel9" class="m-wrap span12" placeholder="Dígitos">										
                                                        <input type="text" name="accNivel10" id="accNivel10" class="m-wrap span12" placeholder="Dígitos">										
                                                        <input type="text" name="accNivel11" id="accNivel11" class="m-wrap span12" placeholder="Dígitos">										
                                                        <input type="text" name="accNivel12" id="accNivel12" class="m-wrap span12" placeholder="Dígitos">                                            
                                                    </div>
                                                    <div class="control-group span4 ">
                                                        <input type="text" id="accName1" name="accName1" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
                                                        <input type="text" id="accName2" name="accName2" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">
                                                        <input type="text" id="accName3" name="accName3" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
                                                        <input type="text" id="accName4" name="accName4" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">	
                                                        <input type="text" id="accName5" name="accName5" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
                                                        <input type="text" id="accName6" name="accName6" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">	
                                                        <input type="text" id="accName7" name="accName7" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
                                                        <input type="text" id="accName8" name="accName8" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">	
                                                        <input type="text" id="accName9" name="accName9" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
                                                        <input type="text" id="accName10" name="accName10" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">	
                                                        <input type="text" id="accName11" name="accName11" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
                                                        <input type="text" id="accName12" name="accName12" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">											
                                                    </div>								
                                                </div>
                                                <div class="row-fluid">
                                                    <div class="control-group span5 ">
                                                        <label for="accCode">
                                                            Tipo cuenta
                                                        </label>
                                                        <div class="controls" >  
                                                            <select id="aacType" name="aacType" class="span8">
                                                                <option value="1">Activo</option>
                                                                <option value="2">Pasivo</option>
                                                                <option value="3">Patrimonio</option>
                                                                <option value="4">Ingresos</option>
                                                                <option value="5">Costos Ventas</option>
                                                                <option value="6">Gastos</option>
                                                                <option value="7">Costos Producción</option>
                                                            </select>                                               
                                                        </div>
                                                    </div>
                                                    <div class="control-group span5 ">
                                                        <label  >
                                                        Tipo Saldo
                                                        </label>
                                                        <div class="controls" >  
                                                            <select id="aacTypeBalance" name="aacTypeBalance" class="span7">
                                                                <option value="1">Deudor</option>
                                                                <option value="2">Acreedor</option>
                                                            </select>                                                  
                                                        </div>
                                                    </div>
                                                    <div class="row-fluid">
                                                        <div class="control-group span5 ">
                                                            <label for="accCode">
                                                                Moneda
                                                            </label>
                                                            <div class="controls" >  
                                                                <select id="aacMoney" name="aacMoney" class="span8">
                                                                    <option value="1">Colón</option>
                                                                    <option value="2">Dolar</option>
                                                                </select>                                               
                                                            </div>
                                                        </div>
                                                        <div class="control-group span4 ">                                                  
                                                        </div>
                                                    </div>
                                                    <div class="row-fluid">
                                                        <div class="control-group span8 ">
                                                            <label for="accCode">
                                                                Funcionalidad
                                                            </label>
                                                            <div class="controls" >  
                                                                <textarea id="aacFuncionality" name="aacFuncionality" class="span12">                                                           
                                                                </textarea>                                               
                                                            </div>
                                                        </div>
                                                        <div class="control-group span4 ">                                                  
                                                        </div>
                                                    </div>
                                                    <div class="row-fluid">
                                                        <div class="control-group span8 ">
                                                            <label for="accCode">
                                                                Observaciones
                                                            </label>
                                                            <div class="controls" >  
                                                                <textarea id="aacObservations" name="aacObservations" class="span12">                                                           
                                                                </textarea>                                               
                                                            </div>
                                                        </div>
                                                        <div class="control-group span4 ">                                                  
                                                        </div>
                                                    </div>
                                                    <div class="row-fluid">
                                                        <div class="control-group span3 ">                                                    
                                                        </div>
                                                        <div class="control-group span4 ">   
                                                            <button type="button" class="btn green" onclick="fnAccountingAccount()">Guardar</button>                                               
                                                        </div>
                                                    </div>								
                                                </div>
                                            </div>
                                            <div class="control-group span6 ">
                                                   Aqui iria la parte de la forma de la cuenta
                                            </div>
                                        </div>
                                    </form>
									<!-- <table id="listAsignPermit" class="bt-table"
										data-side-pagination="server"
										data-pagination="true"
										data-page-size="20"
										data-page-list="[20, 40, 60]"
										data-search="true">
									</table> -->
								</div>
							</div>
							<!-- END EXAMPLE TABLE PORTLET-->
						</div>
					</div>
			</div>
			
	</div>	


<% include partials/footer %>
<script type="text/javascript">
    var arrayDataCatalog =[];
	$(document).ready(function(){
        $('#busId').select2({});
        $('#aacType').select2({});
        $('#aacTypeBalance').select2({});
        $('#aacMoney').select2({});   
        $('#aacDirection').select2({});
        $('#accId').select2({});
        aacDirection()
             
        <% if(business.length != 0) { %>
            handleTableData();
            fnGetCatalog();	
        <% }%>
	});
	isFirtsDatatable = true;
	function handleTableData () {
		$('#listAsignPermit').bootstrapTable({
			height: getHeight(),
			method: 'GET',
			url: '/contab/assignHistory/'+$('#busId').val(),
			cache: false,
			columns: [
				{
					field: 'accountingCatalog.accName',
					title: 'Catálogo',
					sortable: true,
					width: '20%'
				}, {
					field: 'accountingCatalog.accCode',
					title: 'Número',
					sortable: true,
					width: '3%'
				}, {
					field: 'accountingCatalog.accIsGlobal',
					title: 'Tipo Catálogo',
					sortable: false,
                    width: '15%',
					formatter: operateFormatter
				}, {
					field: 'user.useName',
					title: 'Usuario',
					sortable: false,
                    width: '15%'
				}, {
					field: 'permitId',
					title: 'Opcion',
					sortable: false,
                    width: '15%',
					formatter: operateFormatter2
                }, {
					field: 'bupId',
					title: 'Eliminar',
					sortable: false,
                    width: '15%',
					formatter: operateFormatter3
                }
                
			]
		});
	};
	function getHeight() {
		return $(window).height();
    }
    
    function operateFormatter(value, row, index) {
        return [
            ((row.accountingCatalog.accIsGlobal == 1) ? "Global" : "Individual"),
        ].join('');
    }
    function operateFormatter2(value, row, index) {
        return [
            ((row.permitId == 1) ? "Consultar" : "Modificar"),
        ].join('');
    }
    function operateFormatter3(value, row, index) {
        return [
            "<button type='button' class='btn red",
            " btnActiveInactive' onclick='fnEliminar("+ row.bupId +")'>",
            "<i class='icon-off'></i> ",
           "Eliminar",
            "</button>"
        ].join('');
    }

    function refreshTable() {
        $('.bt-table').bootstrapTable('refresh', {silent: true});
    }

    // opcion 1 
	// function fnGetCatalog(){
	// 	$.ajax({
    //         type: "GET",
	// 		url: "/contab/getCatalog/"+$('#busId').val(),		
    //         beforeSend: function(){ //se muestra una imagen mientras el ajax se ejecuta
    //             showIsLoading("Procesando...");
    //         }
    //     }).done(function (data) {	
    //         hideIsLoading();	
    //         $('#accIdName').html(data.accountCatalog.accName);
    //         $('#accId').val(data.accountCatalog.accId);
    //         if(data.accountCatalog.accIsGlobal==1){
    //             $('#accIsGlobal').html('Global')
    //         }
    //         else{
    //             $('#accIsGlobal').html('Individual')
    //         }
    //         jsonData = JSON.parse(data.accountCatalog.accNivels)	
    //         showData(jsonData, data.accountCatalog.accQuantityNivels, data.accountCatalog.accSeparator)
    //     }).fail(function (data) {
    //         hideIsLoading();
    //         fnOpenErrorDialog(data.responseJSON.message);
    //     }).always(function (data) {
    //         hideIsLoading();
    //     });
    // }

    // opcion 2
    function fnGetCatalog(){
		$.ajax({
            type: "GET",
			url: "/contab/getCatalogs/"+$('#busId').val(),		
            beforeSend: function(){ //se muestra una imagen mientras el ajax se ejecuta
                showIsLoading("Procesando...");
            }
        }).done(function (data) {	
            hideIsLoading();  
            $("#accId").select2("destroy");
            $("#accId").select2("destroy");
            arrayDataCatalog = data.accountCatalog	    
            var options = $("#accId");	
            for(a=0; a<data.accountCatalog.length; a++){
                options.append($("<option />").val(data.accountCatalog[a].accId).text(data.accountCatalog[a].accName));                               
            }
            $("#accId").select2({});  

            ///////////////         
            // showData(data)
        }).fail(function (data) {
            hideIsLoading();
            fnOpenErrorDialog(data.responseJSON.message);
        }).always(function (data) {
            hideIsLoading();
        });
    }
    $('#accId').change(function (){
        for(a=0; a<arrayDataCatalog.length; a++){
            if(arrayDataCatalog[a].accId==$('#accId').val()){
                console.log(arrayDataCatalog[a])
                showData(arrayDataCatalog[a])
            }                             
        }
    })

    function aacDirection(){
        if($('#aacDirection').val() == 1){
            $('#vertical1').hide();
            $('#vertical2').hide();
            $('#horizontal1').show();
            $('#horizontal2').show();
        }
        else{
            $('#vertical1').show();
            $('#vertical2').show();
            $('#horizontal1').hide();
            $('#horizontal2').hide();
        }
    }
    $('#aacDirection').change(function (){        
        aacDirection()
    })
    $('#busId').change(function (){
        $.ajax({
            type: "GET",
			url: "/contab/getCatalogs/"+$('#busId').val(),			
            beforeSend: function(){ //se muestra una imagen mientras el ajax se ejecuta
                showIsLoading("Procesando...");
            }
        }).done(function (data) {	
            hideIsLoading();
            arrayDataCatalog = data.accountCatalog	 
             ////// seria lo diferente  
            $("#accId").select2("destroy");
            $('#accId option').remove();  
            var options = $("#accId");	
            for(a=0; a<data.accountCatalog.length; a++){              
                options.append($("<option />").val(data.accountCatalog[a].accId).text(data.accountCatalog[a].accName));                               
            }
            $("#accId").select2({});  
            ///////////////          
            // showData(data)
        }).fail(function (data) {
            hideIsLoading();
            fnOpenErrorDialog(data.message);
            $("#accId").select2("destroy");
            $('#accId option').remove(); 
            $("#accId").select2({});
        }).always(function (data) {
            hideIsLoading();
        });
    })

    function showData(data){
        // jsonData = JSON.parse(data.accountCatalog.accNivels)
        // accQuantityNivels = data.accountCatalog.accQuantityNivels
        // accSeparator = data.accountCatalog.accSeparator

        // $('#accIdName').html(data.accountCatalog.accName);
        jsonData = JSON.parse(data.accNivels)
        accQuantityNivels = data.accQuantityNivels
        accSeparator = data.accSeparator

        $('#accIdName').html(data.accName);
        if(data.accIsGlobal==1){
            $('#accIsGlobal').html('Global')
        }
        else{
            $('#accIsGlobal').html('Individual')
        }

        for(var a=1;  a<accQuantityNivels; a++){																	
            $('#accNivel'+a).val('')	
            $('#accNivel'+a).show()
            $('#accName'+a).show()
            $('#labelTextNivel'+a).show()		
        }
        if(accQuantityNivels<13){
            newlimit = accQuantityNivels +1;
            for(var a=newlimit;  a<13; a++){																	
                $('#accNivel'+a).hide()
                $('#labelTextNivel'+a).hide()
                $('#accName'+a).hide()			
            }
        }
        $('#labelTextNivel1').html(jsonData.accName1)
        $('#labelTextNivel2').html(jsonData.accName2)
        $('#labelTextNivel3').html(jsonData.accName3)
        $('#labelTextNivel4').html(jsonData.accName4)
        $('#labelTextNivel5').html(jsonData.accName5)
        $('#labelTextNivel6').html(jsonData.accName6)
        $('#labelTextNivel7').html(jsonData.accName7)
        $('#labelTextNivel8').html(jsonData.accName8)
        $('#labelTextNivel9').html(jsonData.accName9)
        $('#labelTextNivel10').html(jsonData.accName10)
        $('#labelTextNivel11').html(jsonData.accName11)
        $('#labelTextNivel12').html(jsonData.accName12)	

        // queda pendiente lo de nombre de la cuenta??? y el length
        //crear la mascara
        dataMask = ''
        for(var a=1;  a<=jsonData.accNivel1; a++){																	
            dataMask = dataMask+'9'		
        }
        if(jsonData.accNivel2){
            dataMask = dataMask+accSeparator
            for(var a=1;  a<=jsonData.accNivel2; a++){																	
                dataMask = dataMask+'9'		
            }
        }
        if(jsonData.accNivel3){
            dataMask=dataMask+accSeparator
            for(var a=1;  a<=jsonData.accNivel3; a++){																	
                dataMask = dataMask+'9'		
            }
        }
        if(jsonData.accNivel4){
            dataMask=dataMask+accSeparator
            for(var a=1;  a<=jsonData.accNivel4; a++){																	
                dataMask = dataMask+'9'		
            }
        }
        if(jsonData.accNivel5){
            dataMask=dataMask+accSeparator
            for(var a=1;  a<=jsonData.accNivel5; a++){																	
                dataMask = dataMask+'9'		
            }
        }

        
        $("#aacCode").inputmask("mask", {"mask": dataMask, "clearIncomplete": true });
        // el length
        $("#accNivel1").attr('maxlength',jsonData.accNivel1);
        $("#accNivel2").attr('maxlength',jsonData.accNivel2);
        $("#accNivel3").attr('maxlength',jsonData.accNivel3);
        $("#accNivel4").attr('maxlength',jsonData.accNivel4);
        $("#accNivel5").attr('maxlength',jsonData.accNivel5);
        $("#accNivel6").attr('maxlength',jsonData.accNivel6);
        $("#accNivel7").attr('maxlength',jsonData.accNivel7);
        $("#accNivel8").attr('maxlength',jsonData.accNivel8);
        $("#accNivel9").attr('maxlength',jsonData.accNivel9);
        $("#accNivel10").attr('maxlength',jsonData.accNivel10);
        $("#accNivel11").attr('maxlength',jsonData.accNivel11);
        $("#accNivel12").attr('maxlength',jsonData.accNivel12);
    }

    //validar el maxlenth y la mascara al guardar
    function fnAccountingAccount(){
		$.ajax({
            type: "POST",
			url: "/contab/saveAccountingAccount",
            data: $('#accountingAccount').serialize(), //se envia el form serializado          
            beforeSend: function(){ //se muestra una imagen mientras el ajax se ejecuta
                showIsLoading("Procesando...");
            }
        }).done(function (data) {  
            fnOpenSusessDialog(data.message)          
            hideIsLoading();                         
            setTimeout(function(){ refreshTable(); }, 300);
        }).fail(function (data) {
            hideIsLoading();
            fnOpenErrorDialog(data);
        })
    }
</script>