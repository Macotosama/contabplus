<% include partials/header %>
	<!-- BEGIN PAGE -->
	<div class="page-content">

			<!-- BEGIN PAGE CONTAINER-->
			<div class="container-fluid">
				<!-- BEGIN PAGE HEADER-->
				<div class="row-fluid">
					<div class="span12">
						<h3>Empresas</h3>
					</div>
                </div>
                <div class="row-fluid">
                    <div class="span12">
                        <!-- BEGIN EXAMPLE TABLE PORTLET-->
                        <div class="portlet box light-grey">
                            <div class="portlet-title">
                                
                                <div class="tools">
                                    <a href="javascript:;" class="collapse"></a>
                                    <a href="#portlet-config" data-toggle="modal" class="config"></a>
                                    <a href="javascript:;" class="reload"></a>
                                    <a href="javascript:;" class="remove"></a>
                                </div>
                            </div>
                            <div class="portlet-body">
                                <div class="table-toolbar">
                                    <div class="btn-group">
                                        <button id="newBusiness" class="btn green" onclick="$('#modalBusiness').modal('show')">
                                        Empresa <i class="icon-plus"></i>
                                        </button>
                                    </div>
                                    <div class="btn-group pull-right">
                                    </div>
                                </div>
                                <table id="listBusiness" class="bt-table"
                                    data-side-pagination="server"
                                    data-pagination="true"
                                    data-page-size="20"
                                    data-page-list="[20, 40, 60]"
                                    data-search="true">
                                </table>
                            </div>
                        </div>
                        <!-- END EXAMPLE TABLE PORTLET-->
                    </div>
                </div>
			</div>
            <!-- listado de mis empresas -->
            
			<!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
			<div id="modalBusiness" class="modal container hide fade">
				<div class="modal-header">
					<button data-dismiss="modal" class="close" type="button">X</button>
					<h3 id='titleCatalog'>Empresas</h3>
				</div>
				<div class="modal-body">
					<form id="businessCatalog" >
						<input type="hidden" name="busId" id="busId" >
						<div class="row-fluid">
							<div class="control-group span6 ">
								<label for="accCode">
									Nombre
								</label>
								<div class="controls">
									<input type="text" name="busName" id="busName" class="m-wrap span12" placeholder="Nombre" maxlength="100">
								</div>
							</div>							
						</div>
						<div class="row-fluid">
							<div class="control-group span6">
								<label for="accName">
									Correo
								</label>
								<div class="controls">
									<input type="text" name="busEmail" id="busEmail" class="m-wrap span12" placeholder="Email" maxlength="60">
								</div>
							</div>
							<div class="control-group span6 ">
								<label for="accIsGlobal">
									Teléfono
								</label>
								<div class="controls">                                    
                                    <input type="text" name="busPhone" id="busPhone" class="m-wrap span12" placeholder="Teléfono" maxlength="60">
								</div>
							</div>
						</div>							
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn dark btn-outline" data-dismiss="modal">Cerrar</button>
					<button type="button" class="btn green" onclick="fnBusiness()">Guardar</button>
				</div>
			</div>
	</div>
<% include partials/footer %>
<script type="text/javascript">
	$(document).ready(function(){
		handleTableData();
	});
	isFirtsDatatable = true;
	function handleTableData () {
		$('#listBusiness').bootstrapTable({
			height: getHeight(),
			method: 'GET',
			url: '/contab/business',
			cache: false,
			columns: [
				{
					field: 'busName',
					title: 'Nombre',
					sortable: true,
					width: '10%'
				}, {
					field: 'busEmail',
					title: 'Email',
					sortable: true,
					width: '25%'
				}, {
					field: 'busPhone',
					title: 'Teléfono',
					sortable: true,
					width: '5%'
				}, {
					field: 'busStatus',
					title: 'Estado',
					sortable: true,
					width: '15%',
					formatter: operateFormatterState
				}
			]
		});
	};
	function getHeight() {
		return $(window).height();
	}
	function operateFormatterState(value, row, index) {
        return [
            "<button type='button' class='btn ",
            ((row.busStatus == 1) ? "green" : "red"),
            " btnActiveInactive'>",
            "<i class='icon-off'></i> ",
            ((row.busStatus == 1) ? "Activo" : "Inactivo"),
            "</button>"
        ].join('');
    }
	//make catalog
	$('#businessCatalog').validate({
		errorElement: 'label', //default input error message container
		errorClass: 'help-inline', // default input error message class
		ignore: "",
		rules: {
			busName: { required: true },
            busEmail: {required: true},
            busPhone : {required: true}
		},
		messages: { // custom messages
			busName: { required: "El campo es requerido." },
            busEmail: { required: "El campo es requerido." },
            busPhone :{ required: "El campo es requerido." }
		},
		highlight: function (element) { // hightlight error inputs
			$(element).closest('.control-group').addClass('error'); // set error class to the control group
		},
		success: function (label) {
			label.closest('.control-group').removeClass('error');
			label.remove();
		},
		errorPlacement: function (error, element) {
			if (element.closest('.icon-search').size() === 1) {
				error.addClass('help-small no-left-padding').insertAfter(element.closest('.icon-search'));
			} else if (element.next().attr("class")){
				error.addClass('help-small no-left-padding').insertAfter(element.next());
			} else {
				error.addClass('help-small no-left-padding').insertAfter(element);
			}
		},
		submitHandler: function (form) {
			form.submit();
		}
	});
    function refreshTable() {
        $('.bt-table').bootstrapTable('refresh', {silent: true});
    }
	function fnBusiness(){
		if($('#businessCatalog').valid()){
			$.ajax({
				type: "POST",
				url: "/contab/saveBusiness",
				data: $('#businessCatalog').serialize(), //se envia el form serializado
				beforeSend: function(){ //se muestra una imagen mientras el ajax se ejecuta
					showIsLoading("Procesando...");
				}
			}).done(function () {
				$('#modalBusiness').modal('hide');
				hideIsLoading();
				cleanForm();	
				refreshTable(); 						
			}).fail(function (data) {
				fnOpenErrorDialog(data.responseJSON.message);
				hideIsLoading();
			})
		}	
	}
	function cleanForm(){
		$('#busName').val('');
		$('#busPhone').val('');
		$('#busEmail').val('')	
	}
</script>