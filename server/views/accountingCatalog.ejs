<% include partials/header %>
	<!-- BEGIN PAGE -->
	<div class="page-content">

			<!-- BEGIN PAGE CONTAINER-->
			<div class="container-fluid">
				<!-- BEGIN PAGE HEADER-->
				<div class="row-fluid">
					<div class="span12">
						<h3>Catálogo contable</h3>
					</div>
				</div>

				<div class="row-fluid">
						<div class="span12">
							<!-- BEGIN EXAMPLE TABLE PORTLET-->
							<div class="portlet box light-grey">
								<div class="portlet-title">								
								</div>
								<div class="portlet-body">
									<div class="table-toolbar">
										<div class="btn-group">
											<button id="newAccountingCatalog" class="btn green" onclick="cleanForm(); $('#modalAccountingCatalog').modal('show')">
											Catálogo contable <i class="icon-plus"></i>
											</button>
										</div>
										<div class="btn-group pull-right">
											<!-- <button class="btn dropdown-toggle" data-toggle="dropdown">Tools <i class="icon-angle-down"></i>
											</button>
											<ul class="dropdown-menu pull-right">
												<li><a href="#">Print</a></li>
												<li><a href="#">Save as PDF</a></li>
												<li><a href="#">Export to Excel</a></li>
											</ul> -->
										</div>
									</div>
									<table id="listAccountingCatalog" class="bt-table table-striped"
										data-side-pagination="server"
										data-pagination="true"
										data-page-size="20"
										data-page-list="[20, 40, 60]"
										data-search="true">
									</table>
								</div>
							</div>
							<!-- END EXAMPLE TABLE PORTLET-->
						</div>
				</div>
			</div>
			<!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
			<div id="modalAccountingCatalog" class="modal container hide fade">
				<div class="modal-header">
					<button data-dismiss="modal" class="close" type="button">X</button>
					<h3 id='titleCatalog'>Crear Catálogo Contable</h3>
				</div>
				<div class="modal-body">
					<form id="accountingCatalog" >
						<input type="hidden" name="accId" id="accId" >
						<div class="row-fluid">
							<div class="control-group span6 ">
								<label for="accCode">
									Número
								</label>
								<div class="controls">
									<input type="text" name="accCode" id="accCode" class="m-wrap span12" placeholder="Número" maxlength="4">
								</div>
							</div>
							<div class="control-group span6 ">
								<label for="accIsGlobal">
									Tipo
								</label>
								<div class="controls">
									<select id="accIsGlobal" name="accIsGlobal" class="span4 select2">
										<option value="0">Individual</option>
										<option value="1">Global</option>
									</select>
								</div>
							</div>
						</div>
						<div class="row-fluid">
							<div class="control-group ">
								<label for="accName">
									Nombre
								</label>
								<div class="controls">
									<input type="text" name="accName" id="accName" class="m-wrap span12" placeholder="Nombre" maxlength="60">
								</div>
							</div>
						</div>						
						<div class="row-fluid">
							<div class="control-group span12 ">
								<label for="accQuantityNivels">
									Cantidad de niveles
								</label>
								<div class="controls">									
									<select id="accQuantityNivels" name="accQuantityNivels" class="span1 select2">
										<option value="1">1</option>
										<option value="2">2</option>
										<option value="3">3</option>
										<option value="4">4</option>
										<option value="5">5</option>
										<option value="6">6</option>
										<option value="7">7</option>
										<option value="8">8</option>
										<option value="9">9</option>
										<option value="10">10</option>
										<option value="11">11</option>
										<option value="12">12</option>
									</select>
								</div>
							</div>
						</div>
						<div class="row-fluid">
							<div class="control-group span12 ">
								<label>
									Configuracion de niveles
								</label>								
							</div>
						</div>
						<div class="row-fluid">
							<div class="control-group span2 ">
							</div>
							<div class="control-group span2 ">
								<label>
									Dígitos
								</label>									
							</div>
							<div class="control-group span6">
								<label>
									Nombre nivel
								</label>									
							</div>							
						</div>
						<div class="row-fluid">
							<div class="control-group span2 ">
								<label class="span12 labelTextNivel" id="labelTextNivel1">
									Nivel 1
								</label>
								<label class="span12 labelTextNivel" id="labelTextNivel2">
									Nivel 2
								</label>
								<label class="span12 labelTextNivel" id="labelTextNivel3">
									Nivel 3
								</label>
								<label class="span12 labelTextNivel" id="labelTextNivel4">
									Nivel 4
								</label>
								<label class="span12 labelTextNivel" id="labelTextNivel5">
									Nivel 5
								</label>
								<label class="span12 labelTextNivel" id="labelTextNivel6">
									Nivel 6
								</label>
								<label class="span12 labelTextNivel" id="labelTextNivel7">
									Nivel 7
								</label>
								<label class="span12 labelTextNivel" id="labelTextNivel8">
									Nivel 8
								</label>
								<label class="span12 labelTextNivel" id="labelTextNivel9">
									Nivel 9
								</label>	
								<label class="span12 labelTextNivel" id="labelTextNivel10">
									Nivel 10
								</label>
								<label class="span12 labelTextNivel" id="labelTextNivel11">
									Nivel 11
								</label>
								<label class="span12 labelTextNivel" id="labelTextNivel12">
									Nivel 12
								</label>							
							</div>
							<div class="control-group span2 ">
								<input type="text" name="accNivel1" id="accNivel1" class="m-wrap span12" placeholder="Dígitos" maxlength="6">										
								<input type="text" name="accNivel2" id="accNivel2" class="m-wrap span12" placeholder="Dígitos" maxlength="6">
								<input type="text" name="accNivel3" id="accNivel3" class="m-wrap span12" placeholder="Dígitos" maxlength="6">										
								<input type="text" name="accNivel4" id="accNivel4" class="m-wrap span12" placeholder="Dígitos" maxlength="6">
								<input type="text" name="accNivel5" id="accNivel5" class="m-wrap span12" placeholder="Dígitos" maxlength="6">										
								<input type="text" name="accNivel6" id="accNivel6" class="m-wrap span12" placeholder="Dígitos" maxlength="6">
								<input type="text" name="accNivel7" id="accNivel7" class="m-wrap span12" placeholder="Dígitos" maxlength="6">										
								<input type="text" name="accNivel8" id="accNivel8" class="m-wrap span12" placeholder="Dígitos" maxlength="6">
								<input type="text" name="accNivel9" id="accNivel9" class="m-wrap span12" placeholder="Dígitos" maxlength="6">										
								<input type="text" name="accNivel10" id="accNivel10" class="m-wrap span12" placeholder="Dígitos" maxlength="6">										
								<input type="text" name="accNivel11" id="accNivel11" class="m-wrap span12" placeholder="Dígitos" maxlength="6">										
								<input type="text" name="accNivel12" id="accNivel12" class="m-wrap span12" placeholder="Dígitos" maxlength="6">
							</div>
							<div class="control-group span6 ">
								<input type="text" id="accName1" name="accName1" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
								<input type="text" id="accName2" name="accName2" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">
								<input type="text" id="accName3" name="accName3" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
								<input type="text" id="accName4" name="accName4" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">	
								<input type="text" id="accName5" name="accName5" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
								<input type="text" id="accName6" name="accName6" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">	
								<input type="text" id="accName7" name="accName7" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
								<input type="text" id="accName8" name="accName8" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">	
								<input type="text" id="accName9" name="accName9" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
								<input type="text" id="accName10" name="accName10" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">	
								<input type="text" id="accName11" name="accName11" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">										
								<input type="text" id="accName12" name="accName12" class="m-wrap span12" placeholder="Nombre nivel" maxlength="30">											
							</div>							
						</div>
						<div class="row-fluid">
							<div class="control-group span6 ">
								<label class="checkbox">
									<input type="checkbox" value="1" checked id="accSeparatorCheck" /> Sin separador
								</label>								
							</div>
							<div class="control-group span6 " id="divSeparator">
								<label for="accName">
									Separado por
								</label>
								<div class="controls">
									<input type="text" id="accSeparator" name="accSeparator" class="m-wrap span12" placeholder="Separador " maxlength="1">	
								</div>
							</div>
						</div>	
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn dark btn-outline" data-dismiss="modal">Cerrar</button>
					<button type="button" class="btn green" onclick="fnAccountingCatalog()">Guardar</button>
				</div>
			</div>
			
	</div>	
	

<% include partials/footer %>
<script type="text/javascript">
	$(document).ready(function(){
		$('#accIsGlobal').select2({});
		$('#accQuantityNivels').select2({});
		$("#accQuantityNivels, #accIsGlobal").on("select2-opening", function() {
			$('.select2').select2("close");
		});
		handleTableData();
		$('#accQuantityNivels').change(function() {
			for(var i=0; i<13; i++){
				if(i <= $('#accQuantityNivels').val()) {
					$('#labelTextNivel'+i).show();
					$('#accName'+i).show();
					$('#accNivel'+i).show();
				}
				else{
					$('#labelTextNivel'+i).hide();
					$('#accName'+i).hide();
					$('#accNivel'+i).hide();
				}
			}
			
		});
		$('#accSeparatorCheck').change(function() {						
			if( $('#accSeparatorCheck').prop('checked') ) {
				$('#divSeparator').hide();
			}
			else{
				$('#divSeparator').show();
			}
		})

		// hide default values
		$('#divSeparator').hide();
		for(var i=2; i<13; i++){			
				$('#labelTextNivel'+i).hide();
				$('#accName'+i).hide();
				$('#accNivel'+i).hide();
		}
	});
	isFirtsDatatable = true;
	function handleTableData () {
		$('#listAccountingCatalog').bootstrapTable({
			height: getHeight(),
			method: 'GET',
			url: '/contab/accountingCatalog',
			cache: false,
			columns: [
				{
					field: 'accCode',
					title: 'Número de catálogo',
					sortable: true,
					width: '10%'
				}, {
					field: 'accName',
					title: 'Nombre de catálogo',
					sortable: true,
					width: '25%'
				}, {
					field: 'accQuantityNivels',
					title: 'Cantidad de niveles',
					sortable: true,
					width: '5%'
				}, {
					field: 'accIsGlobal',
					title: 'Tipo',
					sortable: true,
					width: '7%',
					formatter: operateFormatterGlobal
				}, {
					field: 'accStatus',
					title: 'Editar',
					sortable: false,
					width: '10%',
					formatter: operateFormatterState
				}
			]
		});
	};
	function getHeight() {
		return $(window).height();
	}
	function operateFormatterState(value, row, index) {
        return [
            "<button type='button' class='btn green' ",
            " onclick='seeData("+row.accId+")'>",
            "<i class='icon-pencil'></i> Editar ",
            "</button>"
        ].join('');
	}
	
	function operateFormatterGlobal(value, row, index) {
		return [
			((row.accIsGlobal==1) ? 'Global': 'Individual')
        ].join('');
	}
	//make catalog
	$('#accountingCatalog').validate({
		errorElement: 'label', //default input error message container
		errorClass: 'help-inline', // default input error message class
		ignore: "",
		rules: {
			accCode: { required: true },
			accName: {required: true}
		},
		messages: { // custom messages
			password: { required: "El campo es requerido." },
			accName: { required: "El campo es requerido." }
		},
		highlight: function (element) { // hightlight error inputs
			$(element).closest('.control-group').addClass('error'); // set error class to the control group
		},
		success: function (label) {
			label.closest('.control-group').removeClass('error');
			label.remove();
		},
		errorPlacement: function (error, element) {
			if (element.closest('.icon-search').size() === 1) {
				error.addClass('help-small no-left-padding').insertAfter(element.closest('.icon-search'));
			} else if (element.next().attr("class")){
				error.addClass('help-small no-left-padding').insertAfter(element.next());
			} else {
				error.addClass('help-small no-left-padding').insertAfter(element);
			}
		},
		submitHandler: function (form) {
			form.submit();
		}
	});
    function refreshTable() {
        $('.bt-table').bootstrapTable('refresh', {silent: true});
    }
	function fnAccountingCatalog(){
		if($('#accountingCatalog').valid()){
			$.ajax({
				type: "POST",
				url: "/contab/accountingCatalog",
				data: $('#accountingCatalog').serialize(), //se envia el form serializado
				beforeSend: function(){ //se muestra una imagen mientras el ajax se ejecuta
					showIsLoading("Procesando...");
				}
			}).done(function () {
				$('#modalAccountingCatalog').modal('hide');
				hideIsLoading();
				cleanForm();	
				refreshTable(); 						
			}).fail(function (data) {
				fnOpenErrorDialog(data.responseJSON.message);
				hideIsLoading();
			})
		}	
	}
	function cleanForm(){
		$('#accId').val('');
		$('#accCode').val('');
		$('#accName').val('');
		$('#accQuantityNivels').val(1).trigger('change');
		for(var a=1;  a<13; a++){			
			$('#accNivel'+a).val('')
			$('#accName'+a).val('')			
		}
		$('#accSeparatorCheck').attr('checked', true);
		$('#accSeparator').val('');
	}

	function seeData(id){
		$.ajax({
				type: "GET",
				url: "/contab/accountingCatalog/"+id,		
				beforeSend: function(){ //se muestra una imagen mientras el ajax se ejecuta
					showIsLoading("Procesando...");
				}
			}).done(function (data) {
				$('#accId').val(id);
				$('#accCode').val(data.accountingCatalog.accCode);
				$('#accName').val(data.accountingCatalog.accName);
				$('#accQuantityNivels').val(data.accountingCatalog.accQuantityNivels).trigger('change');
				$('#accIsGlobal').val(data.accountingCatalog.accIsGlobal).trigger('change');	
				for(var a=1;  a<data.accountingCatalog.accQuantityNivels; a++){																	
					$('#accNivel'+a).val('')
					$('#accName'+a).val('')			
				}					
				jsonData = JSON.parse(data.accountingCatalog.accNivels)	
				$('#accName1').val(jsonData.accName1)
				$('#accName2').val(jsonData.accName2)
				$('#accName3').val(jsonData.accName3)
				$('#accName4').val(jsonData.accName4)
				$('#accName5').val(jsonData.accName5)
				$('#accName6').val(jsonData.accName6)
				$('#accName7').val(jsonData.accName7)
				$('#accName8').val(jsonData.accName8)
				$('#accName9').val(jsonData.accName9)
				$('#accName10').val(jsonData.accName10)
				$('#accName11').val(jsonData.accName11)
				$('#accName12').val(jsonData.accName12)	

				$('#accNivel1').val(jsonData.accNivel1)
				$('#accNivel2').val(jsonData.accNivel2)
				$('#accNivel3').val(jsonData.accNivel3)
				$('#accNivel4').val(jsonData.accNivel4)
				$('#accNivel5').val(jsonData.accNivel5)
				$('#accNivel6').val(jsonData.accNivel6)
				$('#accNivel7').val(jsonData.accNivel7)
				$('#accNivel8').val(jsonData.accNivel8)
				$('#accNivel9').val(jsonData.accNivel9)
				$('#accNivel10').val(jsonData.accNivel10)
				$('#accNivel11').val(jsonData.accNivel11)
				$('#accNivel12').val(jsonData.accNivel12)	
				
				if(data.accountingCatalog.accSeparator!=''){
					$('#accSeparatorCheck').attr('checked', false);
					$('#divSeparator').show();
				}
				else{
					$('#accSeparatorCheck').attr('checked', true);
					$('#divSeparator').hide();
				}				
				$('#accSeparator').val(data.accountingCatalog.accSeparator);
				$('#modalAccountingCatalog').modal('show');
				hideIsLoading();								
			}).fail(function (data) {
				fnOpenErrorDialog(data.responseJSON.message);
				hideIsLoading();
			})
	}
</script>